FROM golang:1.22-alpine AS builder

RUN apk add --no-cache git make bash findutils grep sed

WORKDIR /build
RUN git clone --branch v3.5.16 --depth 1 https://github.com/etcd-io/etcd.git
WORKDIR /build/etcd

# -------------------------------------------------------------------
# PATCH 1: Increase BoltDB DefaultBoltTimeout from 10s → 60s
# -------------------------------------------------------------------
RUN echo ">>> Searching for DefaultBoltTimeout..." && \
    FILE=$(grep -RIl "DefaultBoltTimeout" server || true) && \
    echo ">>> Found timeout definition in: $FILE" && \
    echo ">>> BEFORE patch:" && \
    grep -n "DefaultBoltTimeout" "$FILE" || true && \
    echo ">>> Applying 10s → 60s timeout patch..." && \
    sed -i 's/DefaultBoltTimeout = 10 \* time.Second/DefaultBoltTimeout = 60 * time.Second/' "$FILE" && \
    echo ">>> AFTER patch:" && \
    grep -n "DefaultBoltTimeout" "$FILE" || true

# -------------------------------------------------------------------
# PATCH 2: Reduce InitialMmapSize from 10GB → 2GB (your original patch)
# -------------------------------------------------------------------
RUN BACKEND_FILE=$(find . -name "*.go" -type f -exec grep -l "InitialMmapSize.*1024.*1024.*1024" {} \; | head -1) && \
    echo ">>> Found InitialMmapSize in: $BACKEND_FILE" && \
    echo ">>> BEFORE patch:" && \
    grep -n "InitialMmapSize" "$BACKEND_FILE" && \
    sed -i 's/10 \* 1024 \* 1024 \* 1024/2 * 1024 * 1024 * 1024/g' "$BACKEND_FILE" && \
    echo ">>> AFTER patch:" && \
    grep -n "InitialMmapSize" "$BACKEND_FILE"

# -------------------------------------------------------------------
# Build etcd (unchanged)
# -------------------------------------------------------------------
RUN make build

# -------------------------------------------------------------------
# Runtime container (unchanged)
# -------------------------------------------------------------------
FROM alpine:3.19
RUN apk add --no-cache ca-certificates curl jq

COPY --from=builder /build/etcd/bin/etcd /usr/local/bin/
COPY --from=builder /build/etcd/bin/etcdctl /usr/local/bin/

COPY entrypoint.sh /tmp/entrypoint.sh
RUN chmod +x /tmp/entrypoint.sh

EXPOSE 2379 2380

ENTRYPOINT ["sh", "/tmp/entrypoint.sh"]
CMD ["etcd"]
